#!/bin/bash

# Define the repository URL
REPO_URL="https://github.com/danidoble/dockerize-laravel/archive/refs/heads/main.tar.gz"
TEMP_DIR=$(mktemp -d)

# cleanup function
cleanup() {
    rm -rf "$TEMP_DIR"
}
trap cleanup EXIT

echo "Starting installation of Dockerize Laravel..."

# Check dependencies
if ! command -v curl &> /dev/null && ! command -v wget &> /dev/null; then
    echo "Error: curl or wget is required."
    exit 1
fi

if ! command -v tar &> /dev/null; then
    echo "Error: tar is required."
    exit 1
fi

# Download the repository
echo "Downloading configuration files..."
if command -v curl &> /dev/null; then
    curl -L "$REPO_URL" -o "$TEMP_DIR/repo.tar.gz"
else
    wget "$REPO_URL" -O "$TEMP_DIR/repo.tar.gz"
fi

if [ $? -ne 0 ]; then
    echo "Error: Failed to download repository."
    exit 1
fi

# Extract the archive
echo "Extracting files..."
tar -xzf "$TEMP_DIR/repo.tar.gz" -C "$TEMP_DIR"

# Identify the extracted directory (it usually has the commit hash or branch name)
EXTRACTED_DIR=$(find "$TEMP_DIR" -mindepth 1 -maxdepth 1 -type d | head -n 1)

if [ -z "$EXTRACTED_DIR" ]; then
    echo "Error: Could not find extracted directory."
    exit 1
fi

# Copy files
echo "Copying configuration files to project root..."

# Create docker directory if it doesn't exist (though cp -r handles it)
cp -r "$EXTRACTED_DIR/docker" .
cp "$EXTRACTED_DIR/compose.dev.yaml" .
cp "$EXTRACTED_DIR/compose.prod.yaml" .
cp "$EXTRACTED_DIR/.gitignore" .gitignore.docker

# Build gitignore
if [ -f ".gitignore" ]; then
    echo "Updating .gitignore..."
    # Append content if not already present, simple check
    if ! grep -q "compose.dev.yaml" .gitignore; then
        echo "" >> .gitignore
        echo "# Dockerize Laravel" >> .gitignore
        echo "compose.dev.yaml" >> .gitignore
        echo "compose.prod.yaml" >> .gitignore
        echo "postgres-data-development" >> .gitignore
        echo "postgres-data-production" >> .gitignore
         echo "mysql-data-development" >> .gitignore
        echo "mysql-data-production" >> .gitignore
    fi
else
    mv .gitignore.docker .gitignore
fi
rm .gitignore.docker

# Handle .env
echo "Checking environment configuration..."
if [ ! -f ".env" ]; then
    echo ".env file not found. Copying .env.example from Dockerize Laravel..."
    cp "$EXTRACTED_DIR/.env.example" .env
    echo "Please update .env with your specific configuration."
else
    echo ".env file exists. Checking for differences..."
    # We want to compare the current .env with the one from the repo
    # But strictly speaking, we might just want to show what's new/different
    diff -u .env "$EXTRACTED_DIR/.env.example" > "$TEMP_DIR/env.diff"
    
    if [ -s "$TEMP_DIR/env.diff" ]; then
        echo "Differences found between your .env and the recommended Docker configuration:"
        echo "--------------------------------------------------------------------------------"
        cat "$TEMP_DIR/env.diff"
        echo "--------------------------------------------------------------------------------"
        echo "Review the diff above and manually update your .env file if necessary."
    else
        echo "Your .env file appears to match the structure of the recommended configuration."
    fi
fi

echo "Installation complete!"
echo "You can now run:"
echo "  docker compose -f compose.dev.yaml up -d"
